<!DOCTYPE html>
<meta charset="utf-8">
<style>

html, body{
  height: 100%;
  font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica, Arial, "Lucida Grande", sans-serif;
  font-weight: 300;
}

body {
  background: #000;
  min-width: 1200px;
}

#container {
  height: 960px;
}


#searchArea {
  height: 100%;
  width: 210px;
  float: left;
  background: transparant;
}

#searchResults {
  height: 100%;
  overflow: scroll;
  padding-top: 10px;
}

.map {
  float: left;
  width: 960px;
}

#resetZoom {
  color: white;
  cursor: pointer;
  z-index: 999;
  float: right;
  font-size: 24px;
}

.land {
  fill: rgb(48,52,56);
}

.mesh {
  fill: none;
  stroke: #000;
  stroke-width: 1px;
}

.hidden {
  display: none
}

.states {
  fill: none;
}

.player {
  fill: rgb(166,189,219);
  cursor: pointer;
}

.player.selected {
  stroke: yellow;
  stroke-width: .25px;
}

.player.active {
  fill: rgb(43,140,190);
}


.sr {
  cursor: pointer;
  color: white;
  padding-bottom: 5px;
}


div.hud {
  position: absolute;
  line-height: 10px;
  text-align: left;
  width: 500px;
  height: 105px;
  padding: 12px;
  background-color: rgba(255,255,255,0.85);
  border: 0px;
  border-radius: 8px;
  pointer-events: none;
}

.hud .title {
  font-weight: bold;
  font-size: 24px;
}

.hud .head {
  float: left;
  height: 105px;
  width: 70px;
}

.hud .head img {
  height: 100%;
  width: 100%;
}

.hud .main {
  float: left;
  padding-left: 12px;
  padding-top: 5px;
}





</style>

<body>

<div class="hud hidden" id="playerHud">
  <div class="head">
    <img id="hudHeadshot" src=""/>
  </div>
  <div class="main">
    <span id="hudName" class="title"></span>
    <span id="hudNumber"></span>
    <p id="hudTeam" class=""></p>
    <p id="hudTown" class=""></p>
    <p id="hudPosition" class""></p>
  </div>
</div>

<div id="container">
  <div id="searchArea">
    <div id="searchInput" class="hidden">
      <input id="playerSearch">
    </div>
    <div id="searchResults">
    </div>
  </div>

  <div class="map">
    <div id="resetZoom" class="hidden" > Reset Zoom </div>
    <svg id="visualization"> </svg>
  </div>
</div>
<script src="lib/d3.v3.min.js"></script>
<script src="lib/queue.v1.min.js"></script>
<script src="lib/topojson.v1.min.js"></script>
<script src="lib/lodash.min.js"></script>
<script src="lib/jquery-1.11.1.min.js"></script>
<script>
'use strict'

var APP = function () {
  var app = this;
  app.width = 960;
  app.height = 960;
  app.playerSize = 4;
  app.active = d3.select(null);
  app.playerHudPinned = false;

  app.f = {
    init: function (error, world, playerData) {

      var svg = app.svg = d3.select("#visualization")
          .attr("width", app.width)
          .attr("height", app.height)
          .on("click", app.f.behaviors.stopped, true);

      app.playerHud = $("#playerHud")

      var features_g = app.features_g = svg.append("g");
      app.land_g = features_g.append("g").attr("class", "land");
      app.states_g = features_g.append("g").attr("class", "states");
      app.players_g = features_g.append("g").attr("class", "players");

      app.f.drawMap(world);


      app.playerLocations = makePlayerMap(playerData);
      app.f.drawPlayers();
      $("#playerSearch").trigger("input");
      $("#searchInput").removeClass("hidden");
      $("#resetZoom").removeClass("hidden");

      //initialize zoom handling
      svg.call(app.zoom).call(app.zoom.event);
    },


    drawMap: function(world) {
      var countryFeatures = topojson.feature(world, world.objects.countries).features;
      //var stateFeatures = topojson.feature(world, world.objects.states).features;


      app.projection =  d3.geo.mercator()
                          .scale((app.width + 1) / 2 / Math.PI)
                          .translate([app.width / 2, app.height / 2])
                          .precision(.1);


      app.zoom =  d3.behavior.zoom()
                    .translate([0, 0])
                    .scale(1)
                    .scaleExtent([1, 27])
                    .on("zoom", app.f.behaviors.zoom);

      var path = d3.geo.path()
          .projection(app.projection);

      var land = app.land_g;
      var states = app.states_g;

      land.selectAll("path")
          .data(countryFeatures)
          .enter().append("path")
          .attr("d", path);

      land.append("path")
          .datum(topojson.mesh(world, world.objects.countries))
          .attr("class", "mesh")
          .attr("d", path);


    //TODO fix the states, show all of US and canada?
    /*
    states.selectAll("path")
          .data(stateFeatures)
          .enter().append("path")
          .attr("class", function(d) {
            return "hidden " + d.id;
          })
          .attr("d", path);

    states.append("path")
          .datum(topojson.mesh(world, world.objects.states))
          .attr("class", "mesh")
          .attr("d", path);
          */

    },


    drawPlayers: function () {
      //TODO make this data static before runtime
      var players = app.players =   _.chain(app.playerLocations.values())
                                     .pluck('players')
                                     .flatten()
                                     .reduce(function(memo, p){
                                        memo[p.id] = p;
                                        return memo;
                                     }, {})
                                     .value();
      var projection = app.projection;

      app.players_g
        .selectAll("circle")
        .data(_.values(players))
        .enter().append("circle")
        .attr("id", function(d) {
          return d.id;
        })
        .attr("cx", function (d) {
          return d.projection.x;
        })
        .attr("cy", function (d) {
          return -20;
        })
        .attr("class", "player")
        .attr("r", app.playerSize / app.zoom.scale())
        .on("mouseover", app.f.showPlayerHud )
        .on("mouseout", app.f.hidePlayerHud )
        .on("click", app.f.behaviors.playerClicked)


        .transition().duration(2000)
        .delay(function(d, i) { return (i * 3); })
        .attr("cx", function (d) {
          return d.projection.x
        })
        .attr("cy", function (d) {
          var loc = d.location;
          return d.projection.y
        })

    },


    showPlayerHud: function (player) {
        app.playerHudPinned = false;
        var hud = app.playerHud;

        hud.find("#hudName").text(player.name);
        hud.find("#hudTeam").text(player.team);
        hud.find("#hudTown").text(player.town);
        hud.find("#hudPosition").text(player.position);
        hud.find("#hudNumber").text(player.number);
        hud.find("#hudHeadshot").attr("src", player.headshot);

        var textWidth = Math.max(
          player.name.length * 15 + 30,
          player.town.length * 9,
          250
        );

        var width = textWidth + 100;
        var offset = $("#"+player.id).offset();

        hud.css({
          left: offset.left - width/2 + "px",
          top: offset.top - 145 + "px",
          width: width + "px",
        })
        /*
        hud.css({
              left: d3.event.pageX - width/2 + "px",
              top: d3.event.pageY - 145 + "px"
            })
        */
            .removeClass("hidden")
    },


    hidePlayerHud: function () {
      if( !app.playerHudPinned ) {
        app.playerHud.addClass("hidden");
      }
    },


    pinPlayerHud: function (player) {
      var width = parseInt(app.playerHud.css("width").split("px")[0]);
      var offset = $("#"+player.id).offset();

      app.playerHud.css({
        left: offset.left - width/2 + "px",
        top: offset.top - 145 + "px"
      })
      .removeClass("hidden");

      app.playerHudPinned = player;
    },



    showPlayersFor: function (country) {
      app.players_g.selectAll("circle")
               .filter(function(d) {
                  return d.country === country;
               })
               .classed("active", true);
    },



    randomIntFromInterval: function (min,max) {
        return Math.floor(Math.random()*(max-min+1)+min);
    },






    playerSearchClick: function () {
      var id = $(this).data("id");
      var el = $("#"+id)[0];
      var player = app.players[id];
      app.f.showPlayerHud(player)
      app.f.behaviors.playerClicked.call(el, player);
    },





    filterSearch: function () {
      var $this = $(this);
      var delay = 500;

      clearTimeout($this.data('timer'));
      $this.data('timer', setTimeout(function(){
        console.log('starting search');
        $this.removeData('timer');
        var text = $this.val();
        var regexp = new RegExp(text, 'i');

        var ps = _.filter(app.players, function(p) {
          return regexp.test(p.name) ||
                 regexp.test(p.team) ||
                 regexp.test(p.town) ;
        });

        //$searchResults.children().remove();
        var html = '';
        _.each(ps, function(p) {
          html +=  '<div class="sr" data-id="'+p.id+'">' +
            p.name +
            '</div>';
        });

        var $searchResults = $("#searchResults");
        $searchResults.html(html);
        $('.sr').click(app.f.playerSearchClick);

      }, delay));
    },





    behaviors: {

      zoom: function () {
        var players_g = app.players_g,
            features_g = app.features_g;

        players_g.selectAll('circle').attr("r", app.playerSize / d3.event.scale);
        features_g.selectAll(".mesh").style("stroke-width", 1 / d3.event.scale + "px");
        features_g.select(".states").style("stroke-width", 1 / d3.event.scale + "px");
        features_g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");

        if(app.playerHudPinned) {
          app.f.pinPlayerHud(app.playerHudPinned);
        }
      },



      playerClicked: function (d) {
        var active = app.active;
        if (active.node() === this) return app.f.behaviors.reset();

        app.players_g.selectAll("circle").classed("active selected", false);

        active.classed("active", false);

        app.active = d3.select(this).classed("active selected", true);

        var loc = d.location,
            proj = app.projection([loc.lng, loc.lat]),
            x = proj[0],
            y = proj[1],
            scale = Math.max(app.zoom.scale(), 7),
            translate = [app.width / 2 - scale * x, app.height / 2 - scale * y];

        app.svg.transition()
                .duration(750)
                .call(app.zoom.translate(translate).scale(scale).event)
                .each("start", app.f.hidePlayerHud)
                .each("end", function () {
                  app.f.pinPlayerHud(d);
                });

        app.f.showPlayersFor(d.country);

      },



      reset: function () {
        app.players_g.selectAll("circle").classed("active selected", false);
        app.active.classed("active selected", false);


        app.active = d3.select(null);

        app.svg.transition()
            .duration(750)
            .call(app.zoom.translate([0, 0]).scale(1).event)
            .each("start", app.f.hidePlayerHud);
      },

      // If the drag behavior prevents the default click,
      // also stop propagation so we don’t click-to-zoom.
      stopped: function () {
        if (d3.event.defaultPrevented) d3.event.stopPropagation();
      }

    }

  }

  $("#playerSearch").on("input", app.f.filterSearch);
  $("#resetZoom").click(app.f.behaviors.reset);
}

var app;
queue()
    .defer(d3.json, "data/world.json")
    .defer(d3.json, "data/playerProfilesWithGeo.json")
    .await( function ready(error, world, players) {
      app = new APP();
      app.f.init(error, world, players);
      d3.select(self.frameElement).style("height", app.height + "px")
    })

function makePlayerMap(players) {
  var locations = d3.map();

  _.each(players, function (p, i) {
    if( p.geo.status !== 'OK' ) return;

    var geo = p.geo.results[0];

    var country = _.find(geo.address_components, function(g) {
        return _.contains(g.types, 'country');
    });


    var state = _.find(geo.address_components, function(g) {
        return _.contains(g.types, 'administrative_area_level_1');
    });

    if(country) {
      var key;

      var countryName = country.short_name;

      var loc = locations.get(key) || {};
      var players = loc.players || [];
      var count = loc.count || 0;

      var geoLocation = geo.geometry.location;

      var proj = app.projection([geoLocation.lng, geoLocation.lat]);
      players.push({
        id: "p_"+i,
        name: p.name,
        location: geoLocation,
        country: countryName,
        birthday: p.birthday,
        town: p.town,
        team: p.team,
        number: p.number.length ? "#" + p.number : "",
        position: p.position,
        headshot: "/images/headshots/"+p.id+".jpg",
        projection: {
          x: proj[0],
          y: proj[1]
        }
      })

      locations.set(key, {
        name: key,
        count: count+=1,
        players: players
      });
    }

  });

  return locations;
}






</script>
</body>
</html>
